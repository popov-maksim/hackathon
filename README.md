# Архитектура системы

Система состоит из нескольких сервисов, общающихся через HTTP и очередь сообщений.

## API
FastAPI-сервис, работающий поверх PostgreSQL через SQLAlchemy. Предоставляет HTTP‑интерфейс для регистрации команд, запуска проверок, выдачи датасетов и просмотра лидерборда. При старте прогона сервис читает датасет и отправляет задания в очередь Yandex Message Queue (совместимую с SQS).

## Telegram-бот
Бот на основе aiogram, взаимодействующий с API через HTTP. С его помощью пользователи регистрируются, запускают проверки, скачивают датасеты и отслеживают результаты.

## Обработка прогонов
Для асинхронной оценки ответов используется очередь сообщений:
- **predict_worker** – воркер/функция, подписанная на YMQ. Получает задания, обращается к пользовательским эндпоинтам, сохраняет результаты и метрики в базу.
- **run_finalizer** – периодическая функция, завершающая прогоны: подсчитывает итоговые метрики и отмечает прогоны как выполненные или истекшие по времени.

Общие модули (модели БД, схемы и конфигурация) размещены в директории `common` и используются всеми компонентами.

## Масштабирование
- **API и бот** запускаются в отдельных контейнерах Docker и могут масштабироваться горизонтально за балансировщиком.
- **Очередь YMQ** обеспечивает параллельную обработку заданий. Количество одновременно выполняемых запросов настраивается через переменную `WORKER_MAX_CONCURRENCY`; возможен запуск нескольких экземпляров воркера.
- **База данных** вынесена в отдельный сервис PostgreSQL, который можно масштабировать и реплицировать стандартными средствами.

Такое разделение компонентов позволяет увеличивать производительность системы, распределяя нагрузку между сервисами и воркерами.
